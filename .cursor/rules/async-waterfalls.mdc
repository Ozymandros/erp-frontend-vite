---
description: "Eliminate async waterfalls by parallelizing independent operations and deferring await until needed"
globs: ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"]
alwaysApply: false
---

# Eliminating Async Waterfalls

**Impact: CRITICAL** - Waterfalls are the #1 performance killer. Each sequential await adds full network latency.

## When Editing Async Code

### Rule 1: Use Promise.all() for Independent Operations

**When you see:** Sequential `await` statements with no dependencies

**Action:** Immediately refactor to `Promise.all()` to parallelize execution.

**Incorrect:**

```typescript
const user = await fetchUser();
const posts = await fetchPosts();
const comments = await fetchComments();
```

**Correct:**

```typescript
const [user, posts, comments] = await Promise.all([
  fetchUser(),
  fetchPosts(),
  fetchComments(),
]);
```

### Rule 2: Defer Await Until Needed

**When you see:** `await` operations before conditional branches

**Action:** Move `await` into the branch where it's actually used.

**Incorrect:**

```typescript
async function handleRequest(userId: string, skipProcessing: boolean) {
  const userData = await fetchUserData(userId); // Blocks even when skipped

  if (skipProcessing) {
    return { skipped: true };
  }
  return processUserData(userData);
}
```

**Correct:**

```typescript
async function handleRequest(userId: string, skipProcessing: boolean) {
  if (skipProcessing) {
    return { skipped: true }; // Returns immediately
  }

  const userData = await fetchUserData(userId); // Only fetch when needed
  return processUserData(userData);
}
```

### Rule 3: Start Promises Early in API Routes

**When you see:** API routes or Server Actions with sequential awaits

**Action:** Start independent operations immediately, even if you don't await them yet.

**Incorrect:**

```typescript
export async function GET(request: Request) {
  const session = await auth();
  const config = await fetchConfig(); // Waits for auth unnecessarily
  const data = await fetchData(session.user.id);
  return Response.json({ data, config });
}
```

**Correct:**

```typescript
export async function GET(request: Request) {
  const sessionPromise = auth();
  const configPromise = fetchConfig(); // Starts immediately

  const session = await sessionPromise;
  const [config, data] = await Promise.all([
    configPromise,
    fetchData(session.user.id),
  ]);
  return Response.json({ data, config });
}
```

## Never Do These

- ❌ Never await operations sequentially when they're independent
- ❌ Never await before checking if the result is needed
- ❌ Never block API routes with sequential awaits when operations can run in parallel
